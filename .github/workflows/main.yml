name: E2E Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  test_linux:
    name: ${{ matrix.os }} (${{ matrix.browser }})
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        os: [ubuntu-18.04, ubuntu-20.04]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout ${{ github.repository }} repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis

      - name: Use Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'
          cache: 'npm'
      
      - name: Cache Node.js modules
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with:
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
        
      - name: Install dependencies
        run: npm ci
        env:
          DEBUG: pw:install
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
        
      - name: Install browsers
        run: npx playwright install --with-deps ${{ matrix.browser }} chromium
        
      - name: Run tests
        run: xvfb-run --auto-servernum --server-args="-screen 0 1366x768x24" -- npx playwright test --project=${{ matrix.browser }} --output=./allure-results/${{ matrix.os }}/${{ matrix.browser }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: allure-results-${{ matrix.os }}-${{ matrix.browser }}
          path: allure-results/${{ matrix.os }}/${{ matrix.browser }}
          retention-days: 30
        
      - name: Get Allure history
        uses: actions/checkout@v2
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
    
      - name: Allure Report with history
        uses: simple-elf/allure-report-action@master
        if: always()
        id: allure-report
        with:
          allure_results: allure-results/${{ matrix.os }}/${{ matrix.browser }}
          gh_pages: gh-pages
          allure_report: allure-report/${{ matrix.os }}/${{ matrix.browser }}
          allure_history: allure-history/${{ matrix.os }}/${{ matrix.browser }}
          keep_reports: 30

      - name: Deploy report to Github Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history/${{ matrix.os }}/${{ matrix.browser }}
          full_commit_message: ${{ github.event.head_commit.message }}
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          force_orphan: true

      - name: Post the link to the report
        uses: Sibz/github-status-action@v1
        if: always()
        with: 
          authToken: ${{ secrets.GITHUB_TOKEN }}
          context: 'Test report'
          description: 'Report is for ${{ matrix.os }} (${{ matrix.browser }})'
          state: 'success'
          sha: ${{ github.event.pull_request.head.sha || github.sha }}
          target_url: https://kshyk.github.io/playwright-fw/${{ github.run_number }}
